<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Advanced Personality Assessment</title>

  <!-- Fonts & Charts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <style>
    :root{
      --bg: #0b0f14;
      --panel:#0f1620;
      --surface:#141c27;
      --text:#e8eef6;
      --muted:#a9b4c1;
      --brand:#6aa6ff;
      --brand-2:#4caf50;
      --accent:#ffd166;
      --danger:#ff6b6b;
      --ok:#67e8f9;
      --border:#1e2a39;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg:#f6f8fb;
      --panel:#ffffff;
      --surface:#ffffff;
      --text:#0b1220;
      --muted:#4b5563;
      --brand:#2563eb;
      --brand-2:#16a34a;
      --accent:#b45309;
      --danger:#dc2626;
      --ok:#0891b2;
      --border:#e5e7eb;
      --shadow: 0 8px 24px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(106,166,255,.18), transparent 50%),
                  radial-gradient(900px 500px at 110% 10%, rgba(22,163,74,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:24px;
    }
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(140%) blur(6px);
      background:linear-gradient(to bottom, rgba(0,0,0,.25), transparent), var(--bg);
      border-bottom:1px solid var(--border);
    }
    .head-row{
      display:flex; align-items:center; gap:12px; justify-content:space-between;
      padding:14px 24px;
      max-width:1100px; margin:0 auto;
    }
    .title{
      display:flex; align-items:center; gap:12px;
    }
    .title .logo{
      width:36px; height:36px; border-radius:10px;
      background: conic-gradient(from 210deg, var(--brand), var(--ok), var(--brand));
      box-shadow: inset 0 0 0 3px rgba(255,255,255,.1), var(--shadow);
    }
    h1{font-size: clamp(20px, 3.2vw, 28px); margin:0; font-weight:700}
    .muted{color:var(--muted)}
    .pill{
      font-size:12px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted);
    }
    .row{display:flex; gap:20px; align-items:stretch}
    .col{flex:1}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 40%), var(--panel);
      border:1px solid var(--border);
      border-radius:14px; padding:18px; box-shadow:var(--shadow);
    }
    .lead{font-size:15px}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap}
    button,.btn{
      appearance:none; border:1px solid var(--border); background:var(--surface);
      color:var(--text); padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer;
      transition:.15s transform ease, .2s background ease, .2s border-color ease, .2s color ease;
    }
    button:hover{transform:translateY(-1px)}
    button:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .btn-primary{background:linear-gradient(180deg, rgba(255,255,255,.08), transparent 50%), var(--brand); border-color:transparent; color:white}
    .btn-success{background:linear-gradient(180deg, rgba(255,255,255,.08), transparent 50%), var(--brand-2); border-color:transparent; color:white}
    .btn-danger{background:linear-gradient(180deg, rgba(255,255,255,.08), transparent 50%), var(--danger); border-color:transparent; color:white}
    .btn-ghost{background:transparent}
    .btn-outline{background:transparent; border-color:var(--brand); color:var(--brand)}
    .right{margin-left:auto}
    .grid{display:grid; gap:16px}
    .grid-2{grid-template-columns:1.2fr .8fr}
    @media(max-width:1000px){.grid-2{grid-template-columns:1fr}}
    .progress{
      height:10px; background:linear-gradient(180deg, rgba(255,255,255,.04), transparent 60%), var(--surface);
      border:1px solid var(--border); border-radius:999px; overflow:hidden; width:100%;
    }
    .progress-inner{height:100%; width:0; background:linear-gradient(90deg, var(--brand), var(--ok)); transition:width .3s ease}
    .progress-row{display:flex; align-items:center; gap:12px}
    .stat{font-size:12px; color:var(--muted)}
    .badge{font-size:12px; background:rgba(255,255,255,.06); border:1px solid var(--border); padding:4px 8px; border-radius:8px}
    .question{
      font-size:18px; font-weight:600; margin:8px 0 14px;
    }
    .likert{
      display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-top:8px;
    }
    .choice{
      position:relative; display:flex; align-items:center; justify-content:center;
      padding:12px 8px; border:1px solid var(--border); background:var(--surface);
      border-radius:10px; font-weight:700; cursor:pointer; user-select:none;
    }
    .choice[data-active="true"]{
      outline:2px solid color-mix(in oklab, var(--brand) 70%, transparent);
      border-color:transparent; background:linear-gradient(180deg, rgba(255,255,255,.08), transparent 45%), color-mix(in oklab, var(--brand) 14%, var(--surface));
    }
    .likert-anchors{display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-top:6px}
    .controls{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .key{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; padding:2px 6px; border:1px solid var(--border); border-radius:6px; color:var(--muted)}
    .krow{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .note{font-size:12px; color:var(--muted)}
    .divider{height:1px; background:linear-gradient(90deg, transparent, var(--border), transparent); margin:14px 0}
    .result{
      display:none; gap:16px;
    }
    .table{width:100%; border-collapse:collapse; font-size:14px}
    .table th,.table td{padding:8px 10px; border-bottom:1px solid var(--border)}
    .chip{display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--border)}
    .good{color:#10b981} .warn{color:#f59e0b} .bad{color:#ef4444}
    .toast{
      position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
      background:var(--panel); border:1px solid var(--border); padding:10px 14px; border-radius:10px; box-shadow:var(--shadow);
      display:none; gap:10px; align-items:center; z-index:60;
    }
    .flag{color:var(--accent); font-weight:700}
    .small{font-size:12px}
    .footer{margin-top:20px; font-size:12px; color:var(--muted); text-align:center}
    .hide{display:none !important}
  </style>
</head>
<body data-theme="dark">
  <header>
    <div class="head-row">
      <div class="title">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Advanced Personality Assessment</h1>
          <div class="muted small">Context-aware, 8-dimension profile • 1–7 Likert scale</div>
        </div>
      </div>
      <div class="toolbar">
        <button id="themeToggle" class="btn-ghost" aria-label="Toggle theme">Toggle Theme</button>
        <span class="pill">Autosaves Locally</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid grid-2">
      <section class="panel col">
        <div class="progress-row">
          <div class="progress" aria-label="Progress"><div id="progressInner" class="progress-inner"></div></div>
          <span id="pct" class="badge">0%</span>
          <span id="counter" class="stat">Q 0 / 120</span>
          <span id="eta" class="stat right">ETA: —</span>
        </div>

        <div class="divider"></div>

        <div id="instructions" class="lead muted">
          Answer honestly. Context appears in each statement (Work / Relationships / Leisure). Scale 1–7, where 1 = strongly disagree and 7 = strongly agree. Keyboard: [1–7]=score, [Enter]=Next, [Backspace]=Prev, [S]=Skip, [F]=Flag.
        </div>

        <div id="qPanel" class="panel" style="margin-top:12px; background:transparent; border-color:transparent; box-shadow:none; padding:0;">
          <div id="questionContainer"></div>
          <div class="controls">
            <button id="prevBtn" class="btn">← Previous</button>
            <button id="skipBtn" class="btn-ghost">Skip</button>
            <button id="flagBtn" class="btn-outline">Flag</button>
            <div class="right"></div>
            <button id="nextBtn" class="btn-primary">Next →</button>
          </div>
          <div class="divider"></div>
          <div class="krow muted small">
            <span class="key">1–7</span> choose score
            <span class="key">Enter</span> next
            <span class="key">Backspace</span> previous
            <span class="key">S</span> skip
            <span class="key">F</span> flag
          </div>
        </div>
      </section>

      <aside class="panel col" id="sidePanel">
        <div class="muted small">Session</div>
        <div style="height:8px"></div>
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
          <button id="resetBtn" class="btn-danger">Reset</button>
          <button id="resumeBtn" class="btn hide">Resume</button>
        </div>
        <div style="height:10px"></div>
        <div class="muted small">Status</div>
        <ul class="small muted" id="statusList" style="margin:6px 0 0 18px">
          <li><span id="flagCount">0</span> flagged for review</li>
          <li><span id="skipCount">0</span> auto-skipped (extreme consistency)</li>
          <li><span id="answeredCount">0</span> answered</li>
        </ul>
        <div class="divider"></div>
        <div class="muted small">Privacy</div>
        <div class="small muted">All data stays in your browser (localStorage). Export options are below when you finish.</div>
      </aside>
    </div>

    <section id="resultSection" class="result grid" style="margin-top:18px; grid-template-columns:1.2fr .8fr">
      <div class="panel">
        <h2 style="margin:0 0 6px">Your Results</h2>
        <div class="muted small">Dimensional profile (0–100 scale). Context effects shown below.</div>
        <canvas id="radarChart" height="340" style="margin-top:10px"></canvas>
        <div class="divider"></div>
        <h3 style="margin:0 0 6px">Summary Table</h3>
        <table class="table" id="resultTable"></table>
      </div>
      <div class="panel">
        <h3 style="margin-top:0">Top & Bottom Dimensions</h3>
        <canvas id="barChart" height="260"></canvas>
        <div class="divider"></div>
        <h3 style="margin:0 0 6px">Context Patterns</h3>
        <div id="contextBlocks" class="grid"></div>
        <div class="divider"></div>
        <h3 style="margin:0 0 6px">Actions</h3>
        <div class="toolbar" style="gap:8px">
          <button id="downloadJson" class="btn">Export JSON</button>
          <button id="downloadCsv" class="btn">Export CSV</button>
          <button id="downloadPng" class="btn">Save Chart PNG</button>
          <button id="printBtn" class="btn">Print</button>
        </div>
        <div class="divider"></div>
        <h3 style="margin:0 0 6px">Flagged Items</h3>
        <div id="flagList" class="small muted">None</div>
        <div class="divider"></div>
        <h3 style="margin:0 0 6px">Personalized Tips</h3>
        <div id="tips" class="small"></div>
      </div>
    </section>

    <div class="footer">© <span id="year"></span> Advanced Personality Assessment • v1.4 • Keyboard first • Accessible</div>
  </main>

  <div id="toast" class="toast"><span id="toastMsg">Saved</span><button class="btn-ghost small" id="toastClose">Close</button></div>

  <script>
    /*************** MODEL ****************/
    const dimensions = [
      'Social Connectivity',
      'Cognitive Exploration',
      'Emotional Regulation',
      'Agreeableness/Empathy',
      'Conscientiousness',
      'Integrity/Honesty',
      'Adaptability/Flexibility',
      'Creativity/Ingenuity'
    ];
    const contexts = ['work','relationships','leisure'];

    const baseStatements = {
      'Social Connectivity': [
        'I enjoy initiating conversations with new people.',
        'I feel energized by social interactions.',
        'I prefer collaborative tasks over solitary work.',
        'I find it easy to network with others.',
        'I thrive in group activities.'
      ],
      'Cognitive Exploration': [
        'I am curious about new ideas and concepts.',
        'I enjoy learning new skills.',
        'I seek intellectual challenges.',
        'I appreciate diverse perspectives.',
        'I like exploring unconventional solutions.'
      ],
      'Emotional Regulation': [
        'I stay calm under pressure.',
        'I manage stress effectively.',
        'I recover quickly from setbacks.',
        'I maintain emotional balance.',
        'I handle criticism without becoming defensive.'
      ],
      'Agreeableness/Empathy': [
        'I empathize with others\' feelings.',
        'I avoid conflict and value harmony.',
        'I am considerate of others\' needs.',
        'I cooperate even when I disagree.',
        'I express gratitude and appreciation.'
      ],
      'Conscientiousness': [
        'I plan and organize tasks carefully.',
        'I pay attention to detail.',
        'I finish tasks on time.',
        'I persist through difficulties.',
        'I follow through on commitments.'
      ],
      'Integrity/Honesty': [
        'I adhere to my principles even under pressure.',
        'I am transparent about my intentions.',
        'I take responsibility for my actions.',
        'I resist temptation to cut corners.',
        'I value fairness and honesty.'
      ],
      'Adaptability/Flexibility': [
        'I adjust quickly to changes.',
        'I adapt my communication style to different people.',
        'I handle unexpected challenges calmly.',
        'I modify my plans when circumstances change.',
        'I am open to feedback and modify my behaviour accordingly.'
      ],
      'Creativity/Ingenuity': [
        'I generate novel ideas.',
        'I enjoy solving problems creatively.',
        'I experiment with new methods.',
        'I see connections others may miss.',
        'I think outside conventional boundaries.'
      ]
    };

    const tipsByDim = {
      'Social Connectivity': ['Schedule regular 1:1s to deepen ties.', 'Practice short icebreakers before group work.'],
      'Cognitive Exploration': ['Block weekly time for deep reading.', 'Join a study circle or forum on new topics.'],
      'Emotional Regulation': ['Use box breathing under time pressure.', 'Track triggers; design pre-emptive routines.'],
      'Agreeableness/Empathy': ['Reflect back what you heard in meetings.', 'Use “steel-manning” for opposing views.'],
      'Conscientiousness': ['Use 2-minute rule and weekly reviews.', 'Define clear “done” criteria before starting.'],
      'Integrity/Honesty': ['Pre-commit to standards publicly.', 'Use checklists to avoid corner-cutting under stress.'],
      'Adaptability/Flexibility': ['Run premortems on plans to consider pivots.', 'Practice “if-then” replan drills.'],
      'Creativity/Ingenuity': ['Carry an idea log; review weekly.', 'Force alternative solutions with SCAMPER.']
    };

    // Build questions (5 per dimension * 3 contexts * 8 dims = 120)
    const questions = [];
    const ctxPrefix = {work:'At work, ',relationships:'In my relationships, ',leisure:'During leisure time, '};
    dimensions.forEach(dim=>{
      contexts.forEach(ctx=>{
        baseStatements[dim].forEach(stmt=>{
          questions.push({ text: ctxPrefix[ctx] + stmt, dimension: dim, context: ctx });
        });
      });
    });

    // Shuffle once for session variety
    function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]} return a }
    shuffle(questions);

    /*************** STATE ****************/
    let current = 0;
    let responses = Array(questions.length).fill(null); // values 1..7 or null
    let flags = new Set(); // indices
    let skipped = new Set(); // auto-skipped indices (unanswered)
    let startedAt = Date.now();
    let timestamps = []; // ms spent per answered
    const STORAGE_KEY = 'apa_v14_session';

    /*************** ELEMENTS ****************/
    const progressInner = document.getElementById('progressInner');
    const pct = document.getElementById('pct');
    const counter = document.getElementById('counter');
    const eta = document.getElementById('eta');
    const questionContainer = document.getElementById('questionContainer');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const skipBtn = document.getElementById('skipBtn');
    const flagBtn = document.getElementById('flagBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const flagCountEl = document.getElementById('flagCount');
    const skipCountEl = document.getElementById('skipCount');
    const answeredCountEl = document.getElementById('answeredCount');
    const resultSection = document.getElementById('resultSection');
    const resultTable = document.getElementById('resultTable');
    const contextBlocks = document.getElementById('contextBlocks');
    const flagList = document.getElementById('flagList');
    const tipsEl = document.getElementById('tips');
    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');
    const toastClose = document.getElementById('toastClose');
    const themeToggle = document.getElementById('themeToggle');

    /*************** UTIL ****************/
    function showToast(msg){
      toastMsg.textContent = msg;
      toast.style.display='flex';
      setTimeout(()=> toast.style.display='none', 2000);
    }
    toastClose.onclick = ()=> toast.style.display='none';

    function save(){
      const payload = {
        current, responses, flags:[...flags], skipped:[...skipped],
        timestamps, startedAt, questions // persist order
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }
    function maybeLoad(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      try{ return JSON.parse(raw) }catch{ return null }
    }
    function clearStorage(){
      localStorage.removeItem(STORAGE_KEY);
    }

    function recomputeSkips(){
      skipped = new Set();
      // For each dimension, find first two answered indices in order, then if extreme, skip later unanswered of same dimension.
      const answeredByDim = Object.fromEntries(dimensions.map(d=>[d, []]));
      for(let i=0;i<questions.length;i++){
        const v = responses[i];
        if(v!=null) answeredByDim[questions[i].dimension].push({i,v});
      }
      dimensions.forEach(dim=>{
        const arr = answeredByDim[dim];
        if(arr.length>=2){
          const avg = (arr[0].v + arr[1].v)/2;
          if(avg<=2 || avg>=6){
            for(let k=0;k<questions.length;k++){
              if(k>arr[1].i && questions[k].dimension===dim && responses[k]==null){
                skipped.add(k);
              }
            }
          }
        }
      });
    }

    function updateHUD(){
      const answered = responses.filter(v=>v!=null).length;
      const p = Math.round((Math.min(current, questions.length)/questions.length)*100);
      progressInner.style.width = p + '%';
      pct.textContent = p + '%';
      counter.textContent = `Q ${Math.min(current+1, questions.length)} / ${questions.length}`;
      flagCountEl.textContent = flags.size;
      skipCountEl.textContent = skipped.size;
      answeredCountEl.textContent = answered;

      // ETA
      const avgMs = timestamps.length ? (timestamps.reduce((a,b)=>a+b,0)/timestamps.length) : 0;
      const remaining = questions.length - answered;
      const etaMin = avgMs ? Math.ceil((remaining*avgMs)/60000) : '—';
      eta.textContent = `ETA: ${etaMin=== '—' ? '—' : etaMin+' min'}`;
    }

    function setTheme(mode){
      document.body.setAttribute('data-theme', mode);
      localStorage.setItem('apa_theme', mode);
    }
    themeToggle.onclick = ()=>{
      const cur = document.body.getAttribute('data-theme');
      setTheme(cur==='dark' ? 'light' : 'dark');
    }
    (function initTheme(){
      const t = localStorage.getItem('apa_theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
      setTheme(t);
    })();

    /*************** RENDER QUESTION ****************/
    let questionStartTime = Date.now();

    function renderQuestion(){
      if(current>=questions.length){ finish(); return; }

      const q = questions[current];
      document.getElementById('instructions').classList.add('hide');

      questionContainer.innerHTML = '';
      const num = document.createElement('div');
      num.className = 'muted small';
      num.textContent = `Question ${current+1} of ${questions.length} • ${q.context.toUpperCase()} • ${q.dimension}`;
      const qt = document.createElement('div');
      qt.className = 'question';
      qt.textContent = q.text;

      const likert = document.createElement('div');
      likert.className = 'likert';
      const currentVal = responses[current];

      for(let i=1;i<=7;i++){
        const cell = document.createElement('div');
        cell.className = 'choice';
        cell.setAttribute('role','radio');
        cell.setAttribute('aria-checked', currentVal===i ? 'true':'false');
        cell.dataset.active = currentVal===i ? 'true':'false';
        cell.textContent = i;
        cell.onclick = ()=> select(i);
        likert.appendChild(cell);
      }

      const anchors = document.createElement('div');
      anchors.className = 'likert-anchors';
      anchors.innerHTML = '<span>Strongly Disagree</span><span>Neutral</span><span>Strongly Agree</span>';

      questionContainer.append(num, qt, likert, anchors);

      prevBtn.disabled = current===0;
      flagBtn.textContent = flags.has(current) ? 'Unflag' : 'Flag';
      skipBtn.disabled = false;

      updateHUD();
      questionStartTime = Date.now();
      save();
    }

    function select(val){
      // record time for previous question selection
      const dt = Date.now() - questionStartTime;
      if(dt>250) timestamps.push(dt);

      responses[current] = val;
      recomputeSkips();
      save();
      renderQuestion(); // to refresh selection highlight
    }

    function next(){
      if(responses[current]==null){
        showToast('Select a response or Skip.');
        return;
      }
      let i = current + 1;
      while(i<questions.length && skipped.has(i)) i++;
      current = i;
      save();
      if(current<questions.length) renderQuestion(); else finish();
    }

    function prev(){
      let i = Math.max(0, current - 1);
      // step back over auto-skipped positions
      while(i>0 && skipped.has(i)) i--;
      current = i;
      renderQuestion();
    }

    function skip(){
      // move forward without answering
      let i = current + 1;
      while(i<questions.length && skipped.has(i)) i++;
      current = i;
      renderQuestion();
    }

    function toggleFlag(){
      if(flags.has(current)) flags.delete(current); else flags.add(current);
      flagBtn.textContent = flags.has(current) ? 'Unflag' : 'Flag';
      updateHUD(); save();
    }

    /*************** RESULTS ****************/
    let radarChart, barChart;

    function finish(){
      document.getElementById('qPanel').classList.add('hide');
      document.getElementById('sidePanel').classList.remove('hide');
      resultSection.style.display = 'grid';

      // Scores
      const dimScores = {}; const contextScores = {}; const countsByDim = {};
      dimensions.forEach(d=>{ dimScores[d]=0; countsByDim[d]=0; });
      for(const ctx of contexts){ contextScores[ctx]={}; dimensions.forEach(d=>contextScores[ctx][d]=[]) }

      questions.forEach((q,idx)=>{
        const v = responses[idx];
        if(v==null) return;
        countsByDim[q.dimension]++;
        dimScores[q.dimension] += v;
        contextScores[q.context][q.dimension].push(v);
      });

      // map 1–7 to 0–100
      dimensions.forEach(d=>{
        if(countsByDim[d]===0) dimScores[d]=0;
        else dimScores[d] = (((dimScores[d]/countsByDim[d]) - 1) / 6) * 100;
      });

      const labels = dimensions.slice();
      const dataValues = labels.map(l=> dimScores[l]||0);

      // Radar
      const rctx = document.getElementById('radarChart').getContext('2d');
      radarChart && radarChart.destroy();
      radarChart = new Chart(rctx, {
        type:'radar',
        data:{ labels, datasets:[{
          label:'Your Profile', data:dataValues, fill:true,
          backgroundColor:'rgba(54,162,235,0.2)', borderColor:'rgba(54,162,235,1)',
          pointBackgroundColor:'rgba(54,162,235,1)'
        }]},
        options:{
          responsive:true,
          plugins:{ legend:{display:false}},
          scales:{ r:{
            suggestedMin:0, suggestedMax:100,
            ticks:{ showLabelBackdrop:false, stepSize:20, color:getComputedStyle(document.body).getPropertyValue('--muted') },
            grid:{ color:getComputedStyle(document.body).getPropertyValue('--border') },
            angleLines:{ color:getComputedStyle(document.body).getPropertyValue('--border') },
            pointLabels:{ color:getComputedStyle(document.body).getPropertyValue('--text') }
          }}
        }
      });

      // Table
      resultTable.innerHTML = `
        <thead><tr><th>Dimension</th><th>Score</th><th class="small muted">Note</th></tr></thead>
        <tbody>
          ${dimensions.map(d=>{
            const s = (dimScores[d]||0);
            const tone = s>=66 ? 'good' : (s>=33?'warn':'bad');
            const note = s>=66 ? 'Strength' : (s>=33?'Balanced':'Growth area');
            return `<tr><td>${d}</td><td><span class="chip">${s.toFixed(1)}</span></td><td class="${tone} small">${note}</td></tr>`
          }).join('')}
        </tbody>`;

      // Top/Bottom (bar)
      const sorted = Object.entries(dimScores).sort((a,b)=>b[1]-a[1]);
      const top3 = sorted.slice(0,3);
      const bottom3 = sorted.slice(-3).reverse();
      const barLabels = [...top3.map(x=>'▲ '+x[0]), ...bottom3.map(x=>'▼ '+x[0])];
      const barData = [...top3.map(x=>x[1]), ...bottom3.map(x=>x[1])];

      const bctx = document.getElementById('barChart').getContext('2d');
      barChart && barChart.destroy();
      barChart = new Chart(bctx, {
        type:'bar',
        data:{ labels:barLabels, datasets:[{ label:'Score', data:barData }]},
        options:{
          indexAxis:'y',
          plugins:{ legend:{display:false}},
          scales:{
            x:{ min:0, max:100, grid:{ color:getComputedStyle(document.body).getPropertyValue('--border')}},
            y:{ grid:{ display:false }, ticks:{ color:getComputedStyle(document.body).getPropertyValue('--text')}}
          }
        }
      });

      // Context blocks
      contextBlocks.innerHTML = '';
      contexts.forEach(ctx=>{
        const rows = dimensions.map(d=>{
          const arr = contextScores[ctx][d];
          if(!arr.length) return [d, 0];
          const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
          return [d, ((avg-1)/6)*100];
        }).sort((a,b)=>b[1]-a[1]);
        const div = document.createElement('div');
        div.className='panel';
        div.innerHTML = `<div class="muted small">${ctx.toUpperCase()}</div>
                         <div style="height:6px"></div>
                         ${rows.map(([d,s])=> `<div class="small" style="display:flex; justify-content:space-between; gap:8px"><span>${d}</span><span class="chip">${s.toFixed(1)}</span></div>`).join('')}`;
        contextBlocks.appendChild(div);
      });

      // Flags
      if(flags.size===0) flagList.textContent='None';
      else {
        flagList.innerHTML = '';
        [...flags].sort((a,b)=>a-b).forEach(idx=>{
          const v = responses[idx]==null ? '—' : responses[idx];
          const el = document.createElement('div');
          el.innerHTML = `<span class="flag">★</span> Q${idx+1}: <span class="small">${questions[idx].text}</span> <span class="chip">Ans: ${v}</span>`;
          flagList.appendChild(el);
        })
      }

      // Tips: show for top1 and bottom1
      const top = sorted[0], bottom = sorted[sorted.length-1];
      tipsEl.innerHTML = `
        <div><strong>Leverage:</strong> ${top[0]} — ${tipsByDim[top[0]].map(t=>`<span class="chip">${t}</span>`).join(' ')}</div>
        <div style="height:8px"></div>
        <div><strong>Develop:</strong> ${bottom[0]} — ${tipsByDim[bottom[0]].map(t=>`<span class="chip">${t}</span>`).join(' ')}</div>
      `;

      // Enable exports
      document.getElementById('downloadJson').onclick = ()=> {
        const data = {
          version:'1.4',
          completedAt: new Date().toISOString(),
          scores: dimScores,
          context: Object.fromEntries(contexts.map(c=>[c, Object.fromEntries(dimensions.map(d=>{
            const arr = (contextScores[c][d]||[]);
            const avg = arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
            return [d, ((avg-1)/6)*100];
          }))])),
          flags:[...flags].map(i=>({ index:i, text:questions[i].text, answer:responses[i] })),
          timeMinutes: Math.round((Date.now()-startedAt)/60000),
          answered: responses.filter(v=>v!=null).length
        };
        downloadBlob(JSON.stringify(data, null, 2), 'assessment.json', 'application/json');
      };

      document.getElementById('downloadCsv').onclick = ()=> {
        const header = 'Dimension,Score\n';
        const rows = dimensions.map(d=> `${csvSafe(d)},${(dimScores[d]||0).toFixed(2)}`).join('\n');
        downloadBlob(header+rows, 'assessment.csv', 'text/csv');
      };

      document.getElementById('downloadPng').onclick = ()=>{
        const link = document.createElement('a');
        link.download = 'radar.png';
        link.href = radarChart.toBase64Image('image/png', 1);
        link.click();
      };

      document.getElementById('printBtn').onclick = ()=> window.print();

      showToast('Results ready');
      save();
    }

    function csvSafe(s){ return `"${String(s).replace(/"/g,'""')}"`; }
    function downloadBlob(content, filename, type){
      const blob = new Blob([content], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    /*************** EVENTS ****************/
    nextBtn.onclick = next;
    prevBtn.onclick = prev;
    skipBtn.onclick = skip;
    flagBtn.onclick = toggleFlag;
    resetBtn.onclick = ()=>{
      if(confirm('Clear all answers and restart?')){ clearStorage(); location.reload(); }
    };
    resumeBtn.onclick = ()=>{
      const stored = maybeLoad();
      if(stored){
        applyState(stored);
        showToast('Session resumed');
        renderQuestion();
      }
    };

    document.addEventListener('keydown', (e)=>{
      if(resultSection.style.display==='grid') return;
      if(e.key>='1' && e.key<='7'){ select(Number(e.key)); }
      else if(e.key==='Enter'){ next(); }
      else if(e.key==='Backspace'){ e.preventDefault(); prev(); }
      else if(e.key==='s' || e.key==='S'){ skip(); }
      else if(e.key==='f' || e.key==='F'){ toggleFlag(); }
    });

    window.addEventListener('beforeunload', (e)=>{
      // warn if incomplete
      if(responses.filter(v=>v!=null).length < questions.length){
        e.preventDefault(); e.returnValue='';
      }
    });

    /*************** SESSION BOOT ****************/
    function applyState(stored){
      if(!stored) return;
      // Only trust length-equal sessions
      if(!stored.questions || stored.questions.length!==questions.length) return;
      // Adopt stored order (important)
      for(let i=0;i<questions.length;i++) questions[i] = stored.questions[i];
      responses = Array.isArray(stored.responses) && stored.responses.length===questions.length ? stored.responses : responses;
      flags = new Set(stored.flags||[]);
      skipped = new Set(stored.skipped||[]);
      timestamps = stored.timestamps||[];
      startedAt = stored.startedAt||Date.now();
      current = Math.min(stored.current||0, questions.length-1);
      recomputeSkips();
      updateHUD();
    }

    (function init(){
      document.getElementById('year').textContent = new Date().getFullYear();
      const stored = maybeLoad();
      if(stored && (stored.responses||[]).some(v=>v!=null) ){
        document.getElementById('resumeBtn').classList.remove('hide');
        // Show a subtle toast but don't auto-resume
        showToast('Previous session found');
      }
      renderQuestion();
    })();
  </script>
</body>
</html>
